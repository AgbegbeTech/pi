angular.module("pi.upload",[]).constant("piUploadConfig",{forceIFrameUpload:!1,url:"/upload",method:"post",multiple:!0,name:"file",iframeName:"piUploadIframe",data:{},start:null,success:angular.noop,error:angular.noop,progress:angular.noop}).directive("piUpload",["piUploadConfig","piUpload",function(l,u){return{restrict:"A",scope:{options:"=piUpload"},link:function(t,a,n){var e,o,r=a.find("button"),p=angular.element('<input type="file">'),i={width:(o=(e=r)[0].getBoundingClientRect()).width||e.prop("offsetWidth"),height:o.height||e.prop("offsetHeight")};l=angular.copy(l),angular.extend(l,t.options),a.css({position:"relative"}),p.css({position:"absolute",display:"block",left:0,top:0,opacity:0,width:i.width+"px",filter:"alpha(opacity=0)",height:i.height+"px"}).attr({multiple:l.multiple,name:l.name}),a.append(p),a.on("click",function(){var t=a.find("input");t.on("change",function(){l.data[l.name]=t,u(l),t.off("change")})})}}}]).factory("piFormDataUpload",["$http","$timeout",function(t,a){return function(e){var t=new XMLHttpRequest,o=new FormData;e.start&&a(e.start),angular.forEach(e.data,function(t,n){n==e.name?1<(t=t[0].files).length?angular.forEach(t,function(t,a){o.append(n+"["+a+"]",t)}):o.append(n,t[0]):o.append(n,t)}),t.upload.addEventListener("progress",function(t){a(function(){e.progress(t)})},!1),t.addEventListener("load",function(t){a(function(){var a=t.target.responseText;try{e.success(angular.fromJson(a))}catch(t){e.error(a)}})},!1),t.open(e.method,e.url),t.send(o)}}]).factory("piIframeUpload",["$timeout",function(r){return function(e){var t=angular.element(document.body),n=angular.element('<iframe name="piUploadIframe">'),o=angular.element("<form>");e.start&&r(e.start),o.attr({target:"piUploadIframe",enctype:"multipart/form-data",method:e.method,action:e.url}).css({display:"none"}),angular.forEach(e.data,function(t,a){var n;a==e.name?(n=t.clone().attr("multiple",!1),t.after(n),o.append(t)):((n=angular.element('<input type="hidden">')).attr({name:a,value:t}),o.append(n))}),o.append(n),t.append(o),n.on("load",function(){var t=this.contentWindow?this.contentWindow.document:this.contentDocument,a=angular.element(t.body).text();r(function(){try{e.success(angular.fromJson(a))}catch(t){e.error(a)}}),n.off("load"),o.remove()}),o[0].submit()}}]).factory("piUpload",["piFormDataUpload","piIframeUpload",function(n,e){var o={formData:window.FormData,XHR:window.XMLHttpRequest,progress:!1};function t(t){if(o.XHR){var a=new XMLHttpRequest;o.progress=!t.forceIFrameUpload&&o.formData&&a.upload}o.progress?n(t):e(t)}return t.support=o,t}]),angular.module("pi.upload",[]).constant("piUploadConfig",{forceIFrameUpload:!1,url:"/upload",method:"post",multiple:!0,name:"file",iframeName:"piUploadIframe",data:{},start:null,success:angular.noop,error:angular.noop,progress:angular.noop}).directive("piUpload",["piUploadConfig","piUpload",function(i,l){return{restrict:"A",scope:{options:"=piUpload"},link:function(t,a){var n,e,o=a.find("button"),r=angular.element('<input type="file">'),p={width:(e=(n=o)[0].getBoundingClientRect()).width||n.prop("offsetWidth"),height:e.height||n.prop("offsetHeight")};i=angular.copy(i),angular.extend(i,t.options),a.css({position:"relative"}),r.css({position:"absolute",display:"block",left:0,top:0,opacity:0,width:p.width+"px",filter:"alpha(opacity=0)",height:p.height+"px"}).attr({multiple:i.multiple,name:i.name}),a.append(r),a.on("click",function(){var t=a.find("input");t.on("change",function(){i.data[i.name]=t,l(i),t.off("change")})})}}}]).factory("piFormDataUpload",["$http","$timeout",function(t,a){return function(e){var t=new XMLHttpRequest,o=new FormData;e.start&&a(e.start),angular.forEach(e.data,function(t,n){n==e.name?1<(t=t[0].files).length?angular.forEach(t,function(t,a){o.append(n+"["+a+"]",t)}):o.append(n,t[0]):o.append(n,t)}),t.upload.addEventListener("progress",function(t){a(function(){e.progress(t)})},!1),t.addEventListener("load",function(t){a(function(){var a=t.target.responseText;try{e.success(angular.fromJson(a))}catch(t){e.error(a)}})},!1),t.open(e.method,e.url),t.send(o)}}]).factory("piIframeUpload",["$timeout",function(r){return function(e){var t=angular.element(document.body),n=angular.element('<iframe name="piUploadIframe">'),o=angular.element("<form>");e.start&&r(e.start),o.attr({target:"piUploadIframe",enctype:"multipart/form-data",method:e.method,action:e.url}).css({display:"none"}),angular.forEach(e.data,function(t,a){var n;a==e.name?(n=t.clone().attr("multiple",!1),t.after(n),o.append(t)):((n=angular.element('<input type="hidden">')).attr({name:a,value:t}),o.append(n))}),o.append(n),t.append(o),n.on("load",function(){var t=this.contentWindow?this.contentWindow.document:this.contentDocument,a=angular.element(t.body).text();r(function(){try{e.success(angular.fromJson(a))}catch(t){e.error(a)}}),n.off("load"),o.remove()}),o[0].submit()}}]).factory("piUpload",["piFormDataUpload","piIframeUpload",function(n,e){function t(t){if(o.XHR){var a=new XMLHttpRequest;o.progress=!t.forceIFrameUpload&&o.formData&&a.upload}o.progress?n(t):e(t)}var o={formData:window.FormData,XHR:window.XMLHttpRequest,progress:!1};return t.support=o,t}]);