<?php
$uid       = Pi::user()->getId();
$userName  = Pi::user()->get($uid, 'name');
$firstName = Pi::user()->get($uid, 'first_name');

if (!isset($groups)) {
    $groups = Pi::registry('display_group', 'user')->read();
}
array_walk($groups, function (&$group, $gid) {
    $action       = $group['compound'] ? 'edit.compound' : 'edit.profile';
    $group['url'] = Pi::service('url')->assemble('user', [
        'module'     => 'user',
        'controller' => 'profile',
        'action'     => $action,
        'group'      => $gid,
    ]);
});
$userConfig = Pi::service('registry')->config->read('user');
$guideConfig = Pi::service('registry')->config->read('guide');

$isPerso = (bool) (
    ($controller == 'dashboard')
    || (isset($sideActive) && $sideActive == 'request')
    || (($module == "guide" && $controller == 'manage' && $action == 'contributions'))
    || ($module == 'favourite')
    || ($module == 'comment')
    || (isset($sideActive) && $sideActive == 'media')
    || ($module == 'user' && $controller != 'dashboardPro')
);

?>

<div class="clearfix sticky-top sticky-top-sidebar sticky-top-sidebar-usersection">
    <div class="custom-control custom-switch custom-switch-usersection p-4">
        <label class="custom-control-label-perso text-warning" for="switch-pro"><?php _e('Perso') ?></label>
        <input type="checkbox" class="custom-control-input" id="switch-pro" value="1" <?php if(!$isPerso) echo 'checked="checked"' ?> data-toggle="toggle" data-target="#nav-pro">
        <label class="custom-control-label custom-control-label-pro  text-muted" for="switch-pro"><?php _e('Pro') ?></label>
    </div>

    <!-- PERSO -->

    <div id="nav-perso" class="nav flex-column nav-pills d-none">
        <a href="<?php echo Pi::url($this->url('user', ['module' => 'user', 'controller' => 'dashboard'])); ?>"
           class="nav-link rounded-0 <?php echo $controller == 'dashboard' ? 'active' : '' ?>">
            <?php _e('Dashboard') ?> <span class='fas fa-angle-right'></span>
        </a>
        <a href="<?php echo Pi::url($this->url('guide', ['module' => 'guide', 'controller' => 'request', 'action' => 'index'])); ?>"
           class="nav-link rounded-0 <?php if (isset($sideActive) && $sideActive == 'request') {echo ' active';} ?>">
            <?php _e('Bookings'); ?> <span class='fas fa-angle-right'></span>
        </a>

        <?php if ($guideConfig['manage_active'] && $guideConfig['manage_contribution']) { ?>
            <a href="<?php echo Pi::url($this->url('guide', ['module' => 'guide', 'controller' => 'manage', 'action' => 'contributions'])); ?>"
               class="nav-link rounded-0 <?php if ($module == "guide" && $controller == 'manage' && $action == 'contributions') {echo ' active';} ?>">
                <?php _e('Contributions'); ?> <span class='fas fa-angle-right'></span>
            </a>
        <?php } ?>

        <?php if (in_array('favourite', $userConfig['side_menu']) && Pi::service('module')->isActive('favourite')) { ?>
            <a href="<?php echo Pi::url($this->url('default', ['module' => 'favourite', 'controller' => 'index', 'action' => 'index'])); ?>"
               class="nav-link rounded-0 <?php if ($module == 'favourite') {echo ' active';} ?>">
                <?php _e('Favorites'); ?> <span class='fas fa-angle-right'></span>
            </a>
        <?php } ?>

        <?php if (in_array('comment', $userConfig['side_menu']) && Pi::service('module')->isActive('comment')) { ?>
            <a href="<?php echo Pi::url($this->url('default', ['module' => 'comment', 'controller' => 'my'])); ?>"
               class="nav-link rounded-0 <?php if ($module == 'comment') { echo ' active';} ?>">
                <?php _e('Reviews/comments'); ?> <span class='fas fa-angle-right'></span>
            </a>
        <?php } ?>

        <?php if (in_array('media', $userConfig['side_menu']) && Pi::service('module')->isActive('media')) { ?>
            <a href="<?php echo Pi::url($this->url('default', ['module' => 'media', 'controller' => 'list', 'action' => 'index'])); ?>"
               class="nav-link rounded-0 <?php if (isset($sideActive) && $sideActive == 'media') { echo ' active'; } ?>">
                <?php _e('Media'); ?> <span class='fas fa-angle-right'></span>
            </a>
        <?php } ?>

        <a class="nav-link rounded-0 collapsed" role="button" data-toggle="collapse"
           href="#collapseItemPerso">
            <?php echo __('My account') ?>
            <span class='fa fa-caret-down float-right mt-1'></span>
        </a>
        <div id="collapseItemPerso" class="panel-collapse collapse <?php if ($module == 'user' && $controller != 'dashboard') echo 'show' ?>" role="tabpanel">
            <a href="<?php echo Pi::url($this->url('user', ['module' => 'user', 'controller' => 'profile'])); ?>"
               class="nav-link rounded-0 pl-5 <?php if ($controller == 'profile') {echo ' active';} ?>">
                <?php echo _e('Manage account'); ?> <span class='fas fa-angle-right'></span>
            </a>

            <a href="<?php echo Pi::url($this->url('user', ['module' => 'user', 'controller' => 'account'])); ?>"
               class="nav-link rounded-0 pl-5 <?php if ($controller == 'account') {echo ' active';} ?>">
                <?php _e('Account settings') ?> <span class='fas fa-angle-right'></span>
            </a>
            <a href="<?php echo Pi::url($this->url('user', ['module' => 'user', 'controller' => 'password'])); ?>"
               class="nav-link rounded-0 pl-5 <?php if ($controller == 'password') {echo ' active';} ?>">
                <?php _e('Change password'); ?> <span class='fas fa-angle-right'></span>
            </a>
            <a href="<?php echo Pi::url($this->url('user', ['module' => 'user', 'controller' => 'avatar'])); ?>"
               class="nav-link rounded-0 pl-5 <?php if ($controller == 'avatar') {echo ' active';} ?>">
                <?php _e('Change avatar'); ?> <span class='fas fa-angle-right'></span>
            </a>
            <?php
            foreach ($groups as $key => $group) {
                ?>
                <a href="<?php echo $group['url']; ?>"
                   class="nav-link rounded-0 pl-5 <?php if (isset($group_id)) {echo $group_id == $key ? ' active' : '';} ?>">
                    <?php echo _escape($group['title']); ?> <span class='fas fa-angle-right'></span>
                </a>
            <?php } ?>
            <a href="<?php echo Pi::url($this->url('user', ['module' => 'user', 'controller' => 'privacy'])); ?>"
               class="nav-link rounded-0 pl-5 <?php if ($controller == 'privacy') {echo ' active';} ?>">
                <?php _e('Privacy'); ?> <span class='fas fa-angle-right'></span>
            </a>
        </div>
    </div>


    <!-- PRO -->

    <div id="nav-pro" class="nav flex-column nav-pills d-none">
        <a href="<?php echo Pi::url($this->url('user', ['module' => 'user', 'controller' => 'dashboardPro'])); ?>"
           class="nav-link rounded-0 <?php echo $controller == 'dashboardPro' ? 'active' : '' ?>">
            <?php _e('Dashboard') ?> <span class='fas fa-angle-right'></span>
        </a>
        <a class="nav-link rounded-0 collapsed" role="button" data-toggle="collapse"
           href="#collapseItem">
            <?php echo (isset($currentTitle) && $currentTitle) ? $currentTitle : __('All') ?>
            <span class='fa fa-caret-down float-right mt-1'></span>
        </a>
        <div id="collapseItem" class="panel-collapse collapse <?php if ($module == 'user' && $controller != 'dashboard') echo 'show' ?>" role="tabpanel">
            <a href="<?php echo Pi::url($this->url('guide', ['module' => 'guide', 'controller' => 'manage', 'action' => 'dashboard'])); ?>"
               class="nav-link rounded-0">
                <?php _e('All'); ?>
            </a>
            <?php if ($guideConfig['manage_active'] && isset($navigationItemList)) { ?>
                <?php foreach ($navigationItemList as $itemId => $itemTitle) : ?>
                    <?php if ($action == 'dashboard') { ?>
                        <a href="<?php echo $this->url(null, ['module' => 'guide', 'controller' => 'manage', 'action' => 'planning', 'item' => $itemId], null, true) ?>"
                           class="nav-link rounded-0 pl-5">
                            <?php echo $itemTitle ?> <span class='fas fa-angle-right'></span>
                        </a>
                    <?php } else { ?>
                        <a href="<?php echo $this->url(null, array('item' => $itemId), null, true) ?>"
                           class="nav-link rounded-0 pl-5">
                            <?php echo $itemTitle ?> <span class='fas fa-angle-right'></span>
                        </a>
                    <?php } ?>
                <?php endforeach; ?>
            <?php } ?>
        </div>

        <?php if ((isset($item['item_type']) && $item['item_type'] == 'commercial') || (isset($item_type) && $item_type == 'commercial') && $guideConfig['manage_active']) { ?>
            <a href="<?php echo Pi::url($this->url('guide', ['module' => 'guide', 'controller' => 'manage', 'action' => 'planning', 'item' => $item['id']])); ?>"
               class="nav-link rounded-0 <?php if ($module == "guide" && $controller == 'planning' && $action == 'index') { echo ' active'; } ?>">
                <?php _e('Summary'); ?> <span class='fas fa-angle-right'></span>
            </a>
        <?php } ?>

        <br />
        <div class="nav-link collapsed">
            <strong ><?php _e('FAST ACTIONS') ?></strong>
            <hr/>
        </div>
        <?php if ((isset($item['item_type']) && $item['item_type'] == 'commercial') || (isset($item_type) && $item_type == 'commercial')) { ?>
            <?php if ($config['manage_service']) { ?>
                <a href="<?php echo $this->url('', array('controller' => 'manage', 'action' => 'sales', 'item' => $item['id'])); ?>"
                   class="nav-link rounded-0 <?php echo $action == "sales" ? 'active' : '' ?> <?php echo $action == "add"  ? 'disabled' : '' ?>">
                    <?php _e('Grid Manager'); ?> <span class='fas fa-angle-right'></span>
                </a>
            <?php } ?>
            <?php if ($config['calendar_active']) { ?>
                <a href="<?php echo $this->url('', array('controller' => 'manage', 'action' => 'calendar', 'item' => $item['id'])); ?>"
                   class="nav-link rounded-0 <?php echo $action == "calendar" || $action == "policies" ? 'active' : '' ?> <?php echo $action == "add"  ? 'disabled' : '' ?>">
                    <?php _e('Bookings/Closings'); ?> <span class='fas fa-angle-right'></span>
                </a>
            <?php } ?>
        <?php } ?>
        <?php if ((isset($item['item_type']) && $item['item_type'] == 'commercial') || (isset($item_type) && $item_type == 'commercial')) { ?>
            <?php if ($config['manage_service']) { ?>
                <a href="<?php echo $this->url('', array('controller' => 'manage', 'action' => 'boost', 'item' => $item['id'])); ?>"
                   class="nav-link rounded-0 <?php echo $action == "boost" ? 'active' : '' ?> <?php echo $action == "add"  ? 'disabled' : '' ?>">
                    <?php _e('Boost'); ?> <span class='fas fa-angle-right'></span>
                </a>
            <?php } ?>
        <?php } ?>

        <a href="<?php echo $this->url('guide', array('module' => 'guide', 'controller' => 'stats', 'action' => 'index', 'item' => isset($item['id']) ? $item['id'] : null)); ?>"
           class="nav-link rounded-0 <?php echo $controller == "stats"  ? 'active' : '' ?> <?php echo $action == "add"  ? 'disabled' : '' ?>">
            <?php _e('Statistics'); ?> <span class='fas fa-angle-right'></span>
        </a>

        <?php if ((isset($item['item_type']) && $item['item_type'] == 'commercial') || (isset($item_type) && $item_type == 'commercial')) { ?>
            <br />
            <div class="nav-link collapsed">
                <strong><?php _e('CONFIGURATION') ?></strong>
                <hr/>
            </div>

            <a href="<?php echo $this->url('', array('module' => 'guide', 'controller' => 'manage', 'action' => 'edit', 'item' => $item['id'])); ?>"
               class="nav-link rounded-0 <?php echo $action == "add" || $action == "edit" || $action == "additional" || $action == "amenities" || $action == "attach" ? 'active' : '' ?>">
                <?php _e('Description'); ?> <span class='fas fa-angle-right'></span>
            </a>

            <?php if ($config['manage_service']) { ?>
                <a href="<?php echo $this->url('', array('controller' => 'manage', 'action' => 'service', 'item' => $item['id'])); ?>"
                   class="nav-link rounded-0 <?php echo $action == "payment" || $action == "service"|| $action == "manage" || $action == "pricelist" || $action == 'children-policy'  ? 'active' : '' ?> <?php echo $action == "add"  ? 'disabled' : '' ?>">
                    <?php _e('Offers/Prices'); ?> <span class='fas fa-angle-right'></span>
                </a>
            <?php } ?>

            <?php if ($business['enable_opening'] || $business['enable_opening_meal_service']) { ?>
                <a href="<?php echo $this->url('', array('controller' => 'manage', 'action' => 'openings', 'item' => $item['id'])); ?>"
                   class="nav-link rounded-0 <?php echo $action == "openings" ? 'active' : '' ?> <?php echo $action == "add"  ? 'disabled' : '' ?>">
                    <?php _e('Opening hours'); ?> <span class='fas fa-angle-right'></span>
                </a>
            <?php } ?>

            <?php if ($config['manage_service']) { ?>
                <a href="<?php echo $this->url('', array('controller' => 'manage', 'action' => 'event-list', 'item' => $item['id'])); ?>"
                   class="nav-link rounded-0 <?php echo $action == "event-list" ? 'active' : '' ?> <?php echo $action == "add"  ? 'disabled' : '' ?>">
                    <?php _e('Events'); ?> <span class='fas fa-angle-right'></span>
                </a>
            <?php } ?>
            <a href="#"
               class="nav-link rounded-0 disabled" style="color:lightgrey!important; background-color:transparent" >
                <?php _e('Deals (Soon)'); ?> <span class='fas fa-angle-right'></span>
            </a>
        <?php } ?>

        <?php if ((isset($item['item_type']) && $item['item_type'] == 'commercial') || (isset($item_type) && $item_type == 'commercial')) { ?>
            <br />
            <div class="nav-link collapsed">
                <strong><?php _e('DISTRIBUTION') ?></strong>
                <hr/>
            </div>

            <a href="<?php echo $this->url('guide', array('module' => 'guide', 'controller' => 'manage', 'action' => 'tools', 'item' => $item['id'])); ?>"
               class="nav-link rounded-0 <?php echo $action == "tools"  ? 'active' : '' ?> <?php echo $action == "add"  ? 'disabled' : '' ?>">
                <?php _e('Widget'); ?> <span class='fas fa-angle-right'></span>
            </a>

            <a href="#"
               class="nav-link rounded-0 disabled" style="color:lightgrey!important; background-color:transparent">
                <?php _e('Sales Channels (Soon)'); ?> <span class='fas fa-angle-right'></span>
            </a>
        <?php } ?>


        <?php if (in_array('guide', $userConfig['side_menu']) && Pi::service('module')->isActive('guide') && $guideConfig['manage_active'] && $guideConfig['sponsor_active']) { ?>
            <a href="<?php echo Pi::url($this->url('guide', ['module' => 'guide', 'controller' => 'manage', 'action' => 'sponsor'])); ?>"
               class="nav-link rounded-0 <?php if (isset($sideActive) && $sideActive == 'sponsor') { echo ' active'; } ?>">
                <?php _e('Sponsorship'); ?> <span class='fas fa-angle-right'></span>
            </a>
        <?php } ?>

        <?php if (in_array('message', $userConfig['side_menu']) && Pi::service('module')->isActive('message')) { ?>
            <?php $message = _number(Pi::api('api', 'message')->getUnread($uid, 'message')); ?>
            <a href="<?php echo Pi::url($this->url('default', ['module' => 'message', 'controller' => 'index', 'action' => 'index'])); ?>"
               class="nav-link rounded-0 <?php if (isset($sideActive) && $sideActive == 'message') { echo ' active'; } ?>">
                <?php _e('Messages'); ?> <span class='fas fa-angle-right'></span>
                <span class="badge badge-warning"><?php echo $message; ?></span>
            </a>

            <?php $notification = _number(Pi::api('api', 'message')->getUnread($uid, 'notification')); ?>
            <a href="<?php echo Pi::url($this->url('default', ['module' => 'message', 'controller' => 'notify', 'action' => 'index'])); ?>"
               class="nav-link rounded-0 <?php if (isset($sideActive) && $sideActive == 'notification') { echo ' active'; } ?>">
                <?php _e('Notifications'); ?> <span class='fas fa-angle-right'></span>
                <span class="badge badge-warning"><?php echo $notification; ?></span>
            </a>
        <?php } ?>

        <?php if (in_array('support', $userConfig['side_menu']) && Pi::service('module')->isActive('support')) { ?>
            <?php $support = _number(Pi::api('ticket', 'support')->getCount($uid)); ?>
            <a href="<?php echo Pi::url($this->url('support', ['module' => 'support', 'controller' => 'index', 'action' => 'index'])); ?>"
               class="nav-link rounded-0 <?php if (isset($sideActive) && $sideActive == 'support') { echo ' active'; } ?>">
                <?php _e('Support tickets'); ?> <span class='fas fa-angle-right'></span>
                <span class="badge badge-warning"><?php echo $support; ?></span>
            </a>
        <?php } ?>

        <?php if (in_array('order', $userConfig['side_menu']) && Pi::service('module')->isActive('order')) { ?>
            <a href="<?php echo Pi::url($this->url('order', ['module' => 'order', 'controller' => 'index', 'action' => 'index'])); ?>"
               class="nav-link rounded-0 <?php if (isset($sideActive) && $sideActive == 'order') { echo ' active'; } ?>">
                <?php _e('Orders'); ?> <span class='fas fa-angle-right'></span>
            </a>

            <?php $orderConfig = Pi::service('registry')->config->read('order'); ?>
            <?php if ($orderConfig['credit_active']) { ?>
                <?php $credit = Pi::api('credit', 'order')->getCredit($uid); ?>
                <a href="<?php echo Pi::url($this->url('order', ['module' => 'order', 'controller' => 'credit', 'action' => 'index'])); ?>"
                   class="nav-link rounded-0 <?php if (isset($sideActive) && $sideActive == 'credit') { echo ' active'; } ?>">
                    <?php _e('Credit'); ?> <span class='fas fa-angle-right'></span>
                    <span class="badge badge-warning"><?php echo $credit['amount_view']; ?></span>
                </a>
            <?php } ?>
        <?php } ?>

        <?php if (in_array('video', $userConfig['side_menu']) && Pi::service('module')->isActive('video')) { ?>
            <a href="<?php echo Pi::url($this->url('video', ['module' => 'video', 'controller' => 'channel', 'action' => 'index'])); ?>"
               class="nav-link rounded-0 <?php if ($module == 'video') { echo ' active'; } ?>">
                <?php _e('Videos'); ?> <span class='fas fa-angle-right'></span>
            </a>
        <?php } ?>

        <?php if (in_array('media', $userConfig['side_menu']) && Pi::service('module')->isActive('media')) { ?>
            <a href="<?php echo Pi::url($this->url('default', ['module' => 'media', 'controller' => 'list', 'action' => 'index'])); ?>"
               class="nav-link rounded-0 <?php if (isset($sideActive) && $sideActive == 'media') { echo ' active'; } ?>">
                <?php _e('Media'); ?> <span class='fas fa-angle-right'></span>
            </a>
        <?php } ?>
    </div>
</div>

<script>
    $(document).ready(function(){
        $('#switch-pro').on('change', function(){
            if($(this).is(':checked')){
                $('#nav-perso').addClass('d-none');
                $('#nav-pro').removeClass('d-none');

                $('.custom-control-label-perso').removeClass('text-warning').addClass('text-muted');
                $('.custom-control-label-pro').addClass('text-warning').removeClass('text-muted');
            } else {
                $('#nav-perso').removeClass('d-none');
                $('#nav-pro').addClass('d-none');

                $('.custom-control-label-perso').addClass('text-warning').removeClass('text-muted');
                $('.custom-control-label-pro').removeClass('text-warning').addClass('text-muted');
            }
        }).trigger('change');
    });
</script>