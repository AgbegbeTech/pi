<?php
$this->bootstrap();
$this->css(
    array(
        $this->assetModule('css/front.css'),
        Pi::url('static/vendor/bootstrap/css/font-awesome.css'),
    )
);

// User data
$user = $comment['user'];
// Count
$count = $comment['count'];
// Comment list generated by comment module:
// id, time, content, user
// uid, name, avatar, profile_url, IP
$posts = $comment['posts'];
// Pagination object
$paginator = $comment['paginator'];

$uid = Pi::user()->id;
$avatar = Pi::avatar()->get($uid, 'medium');
if ($uid) {
    $url = Pi::service('user')->getUrl('profile', $uid);
} else {
    $url = Pi::url('www');
}
if (empty($user)) {
    $user['url'] = $url;
    $user['avatar'] = $avatar;
}
?>

<style>
    .comment-title-hidden {
        display: block;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 40%;
        word-break: keep-all;
        margin: 0 20px 0 5px;
        font-weight: bold;
    }
</style>

<div class="pi-comment">
    <?php echo $this->tab($tabs); ?>
    
    <?php
        if ($posts) {
    ?>
    <div class="pi-comment-list">
    <?php
            foreach ($posts as $post) {d($post);
    ?>
        <div class="media<?php echo 0 == $post['active'] ? ' muted' : '' ?>">
            <a class="pull-left" href="<?php echo $user['url'] ?>" target="_blank">
                <?php echo $user['avatar'] ?>
            </a>
            <div class="media-body">
                <div class="pi-comment-desc" style="margin-top: 0">
                    <span class="muted pull-left"><?php _e('Commented on ') ?></span>
                    <a class="highlight comment-title-hidden pull-left" href="<?php echo $post['target']['url'] ?>" title="<?php echo $post['target']['title'] ?>">
                        <?php echo $post['target']['title'] ?>
                    </a>
                    <span class="muted pi-comment-time"><?php echo date('Y/m/d H:i:s', $post['time']) ?></span>
                    <?php if (0 == $post['active']) { ?>
                    <span class="pull-right label"><?php _e('Pending') ?></span>
                    <?php } ?>
                </div>
                <div class="pi-comment-content<?php echo 0 == $post['active'] ? ' muted' : '' ?>">
                    <?php echo $post['content'] ?>
                </div>
                <div class="pi-comment-operation">
                <?php 
                    foreach ($post['operations'] as $operation => $optData) {
                        $class = '';
                        switch ($operation) {
                            case 'disable':
                                $class = 'icon-ban-circle';
                                break;
                            case 'edit':
                                $class = 'icon-pencil';
                                break;
                            case 'delete':
                                $class = 'icon-trash';
                                break;
                            case 'reply':
                                $class = 'icon-share-alt';
                                break;
                        }
                ?>
                    <span class="operation muted" style="visibility: visible">
                        <a href="<?php echo $optData['url'] ?>">
                            <i class="<?php echo $class ?>" style="text-decoration: none"></i><?php echo $optData['title'] ?>
                        </a>
                    </span>
                <?php
                    }
                ?>
                </div>
            </div>
        </div>
                
    <?php
            }
    ?>
    </div>
    <?php
        } else {
    ?>
    <div class="pi-comment-none"><?php _e('No comments available yet.') ?></div>
    <?php
        }
    ?>
</div>

<?php 
    if ($posts && $paginator) {
        echo $this->pagination(
            $paginator,
            'Sliding',
            'paginator.phtml',
            array('class' => 'pagination-right')
        );
    }
?>