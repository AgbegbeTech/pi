
# DEMO of virtual host configuration for Pi Engine deployment
#
# NOTE: replace contents in [] with your corresponding settings
# By Taiwen Jiang (aka phppp)
#
# Assumption with following folder skeleton
#  Web path: /home/pi/web/
#                                  .htaccess
#                                  boot.php
#                                  lib/
#                                  usr/
#                                  www/
#  Deployment: /home/pi/deployment/
#                                  asset/
#                                  static/
#                                  upload/
#                                  var/
#


# Pi Engine main site
server {
    listen 80;
    # Change the server_name according to your applications
    server_name pialog.org www.pialog.org;
    # Change the root according to your applications
    root [/home/pi/web/www];
    index index.html index.php index.htm;

    # Usually you don't need to change the following settings
    # Dispatch to Pi Engine entry
    # Admin subdoamin
    if ($host ~* ^admin\.(.*)$) {
        rewrite ^(.*)$      /script/admin.php   last;
        break;
    }
    # API subdoamin
    if ($host ~* ^api\.(.*)$) {
        rewrite ^(.*)$      /script/api.php   last;
        break;
    }
    # Feed subdomain
    if ($host ~* ^feed\.(.*)$) {
        rewrite ^(.*)$      /script/feed.php   last;
        break;
    }
    # Widget subdoamin
    if ($host ~* ^widget\.(.*)$) {
        rewrite ^(.*)$      /script/widget.php   last;
        break;
    }
    if (!-e $request_filename) {
        # Admin route
        rewrite ^/admin(/(.*)?)?$   /script/admin.php   last;
        # API route
        rewrite ^/api(/(.*)?)?$     /script/api.php    last;
        # Feed route
        rewrite ^/feed(/(.*)?)?$    /script/feed.php   last;
        # Widget route
        rewrite ^/widget(/(.*)?)?$  /script/widget.php last;
        # Default app route
        rewrite ^/(.+)$             /script/app.php    last;
        break;
    }

    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    location ~ \.php$ {
        #fastcgi_pass   127.0.0.1:9000;
        fastcgi_pass   [unix:/usr/path-to-conf/php-fpm.sock];
        fastcgi_index  index.php;
        include  fastcgi_params;
    }

    # Static files
    # Set expire headers, Turn off access log
    location ~* \.(jpg|jpeg|gif|png|ico|css|js|html|htm)$ {
        access_log off;
        expires max;
        add_header Cache-Control public;
    }
}

# DEMO for Pi Engine asset site IN CASE applicable
server {
    listen 80;
    # Change the server_name according to your applications
    server_name [asset.pialog.org];
    # Change the root according to your applications
    root [/home/pi/deployment/asset];
    index index.html index.htm;

    access_log off;
    expires max;
    add_header Cache-Control public;
}


# DEMO for Pi Engine static (i.e. img) site IN CASE applicable
server {
    listen 80;
    # Change the server_name according to your applications
    server_name [static.pialog.org][ img.pialog.org];
    # Change the root according to your applications
    root [/home/pi/deployment/static];
    index index.html index.htm;

    access_log off;
    expires max;
    add_header Cache-Control public;

    # Font files
    # Set Access-Control-Allow-Origin
    location ~* \.(ttf|otf|eot|woff)$ {
        access_log off;
        expires max;
        add_header Access-Control-Allow-Origin [http://www.pialog.org][*];
    }
}


# DEMO for Pi Engine upload site IN CASE applicable
server {
    listen 80;
    # Change the server_name according to your applications
    server_name [upload.pialog.org];
    # Change the root according to your applications
    root [/home/pi/deployment/upload];
    index index.html index.htm;

    access_log off;
    expires max;
    add_header Cache-Control public;
}